<script type="text/x-red" data-template-name="nest-config">
    <div class="form-row">
        <label for="node-config-input-account"><i class="fa fa-bookmark"></i> Account</label>
        <input type="text" id="node-config-input-account">
    </div>
    <div class="form-row">
        <label for="node-config-input-clientid"><i class="fa fa-bookmark"></i> Client ID</label>
        <input class="input-append-left" type="text" id="node-config-input-clientid">
    </div>
    <div class="form-row">
        <label for="node-config-input-clientsecret"><i class="fa fa-bookmark"></i> Client Secret</label>
        <input class="input-append-left" type="text" id="node-config-input-clientsecret">
    </div>
    <div class="form-row">
        <button id="nest-get-pin">Generate PIN</button>
        <label for="node-config-input-pin"><i class="fa fa-bookmark"></i> PIN</label>
        <input class="input-append-left" type="text" id="node-config-input-pin" style="width: 20%;" >
        <button id="nest-get-token">Generate Token</button>
    </div>
    <div class="form-row">
        <label for="node-config-input-accesstoken"><i class="fa fa-bookmark"></i> Access Token</label>
        <input class="input-append-left" type="password" id="node-config-input-accesstoken">
    </div>
    <div class="form-tips">
        To obtain these credentials, goto <a href="https://developer.nest.com" target="_blank">https://developer.nest.com</a>.
        Once signed up as a Nest developer:
        <ol>
           <li>click "Clients",</li>
           <li>click "Register a new client (I called mine 'Node-Red')",</li>
           <li>populate the forms for your new Node-Red client,</li>
           <li>do <b>not<b> enter anything in the 'OAuth Redirect URI' field (this forces the generation of a PIN)</li>
           <li>click "Create client".</li>
        </ol>
        The clients page will contain the unique "Client ID" and "Client secret" needed in this configuration dialog box.
    </div>
</script>

//</script>

</script>

<script type="text/javascript">
(function() {
    var ncnId = null;

    RED.nodes.registerType('nest-config',{
        category: 'config',
        defaults: { 
            account: {value: "My NEST",required:true}
        },
        credentials: {
            clientid: {type:"text"},
            clientsecret: {type: "text"},
            pin: {type: "text"},
            accesstoken: {type: "password",required:true},
        },
        label: function() {
          return this.account||'nest account';
        },
        oneditprepare: function() {
            //called at launch time
            ncnId = this.id;               
            var cid, csec, pin;
            $("#nest-get-token").click(function() {
                cid = $("#node-config-input-clientid").val();
                csec = $("#node-config-input-clientsecret").val();
                pin = $("#node-config-input-pin").val();
                try {
                    $.get('/nest-credentials/' + ncnId + '/' + cid + '/' + csec + '/' + pin + '/auth',function(data) {
                        //write access token value back out to the form
                    if (data != "Error" && data != "Unauthorised") {
                        $("#node-config-input-accesstoken").val(data); 
                        alert('Access token generated');                       
                    } else {
                        alert('Authorization failed');
                    }
                    });
                } catch(e){
                    console.log('caught an error: ' + e);
                }
            });
            $("#nest-get-pin").click(function() {
                cid = $("#node-config-input-clientid").val();
                if ( cid ) {
                    var pinurl = 'https://home.nest.com/login/oauth2?client_id=' + cid + '&state=STATE'
                    // launch popup
                    window.open(pinurl, "Nest PIN generation").focus();
                } else {
                    alert("Client ID is required to get PIN")
                }
            });
        },
        exportable: false
    });
})();
</script>

<script type="text/x-red" data-template-name="nest request">
    <div class="form-row">
        <label for="node-input-account"><i class="fa fa-user"></i> Account</label>
        <input type="text" id="node-input-account">
    </div>
    <div class="form-row">
        <label for="node-input-devicetype"><i class="fa fa-tag"></i> Type</label>
        <select id="node-input-devicetype" style="width:200px !important">
            <option value="thermostats">Thermostat(s)</option>
            <option value="smoke_co_alarms">Smoke Alarm(s)</option>
            <option value="structures">Structure(s)</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-deviceid"><i class="fa fa-tag"></i> ID</label>
        <input type="text" id="node-input-deviceid">
    </div>
    <div class="form-row">
        <label for="node-input-streaming"><i class="fa fa-empire"></i> Streaming</label>
        <select id="node-input-streaming" style="width:125px !important">
            <option value="false">false</option>
            <option value="true">true</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="nest request">
    <p>Nest request node. Queries your NEST account and returns all NEST device data in either continuous streaming mode or a single request/reply.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('nest request',{
        category: 'Nest',
        color:"#00AFD8",
        defaults: {
            name: {value:""},         
            account: {type:"nest-config",required:true},
            devicetype: {value:"thermostats"},
            deviceid: {value:""},
            streaming: {value:"false"}
        },
        inputs:1,
        outputs:1,
        icon: "nest.png",
        align: "right",
        label: function() {
            return this.name||'nest';
        }
    });
</script>
